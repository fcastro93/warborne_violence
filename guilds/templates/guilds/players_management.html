{% extends 'guilds/base.html' %}

{% block title %}Players Management - Warborne Above Ashes{% endblock %}
{% block page_title %}Players Management{% endblock %}

{% block content %}
<div class="row">
    <!-- Statistics Cards -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="icon primary">
                <i class="fas fa-users"></i>
            </div>
            <h3>{{ total_players }}</h3>
            <p>Total Players</p>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3>{{ active_players }}</h3>
            <p>Active Players</p>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="icon info">
                <i class="fab fa-discord"></i>
            </div>
            <h3>{{ discord_integration_rate }}%</h3>
            <p>Discord Integration</p>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="icon warning">
                <i class="fas fa-sword"></i>
            </div>
            <h3>{{ loadout_completion_rate }}%</h3>
            <p>Loadout Completion</p>
        </div>
    </div>
</div>

<div class="row">
    <!-- Players Table -->
    <div class="col-lg-8 mb-4">
        <div class="stats-card">
            <h4><i class="fas fa-list text-primary"></i> All Players</h4>
            <hr>
            {% if players %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Guild</th>
                                <th>Role</th>
                                <th>Faction</th>
                                <th>Discord</th>
                                <th>Loadout</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for player in players %}
                            <tr>
                                <td>
                                    <strong>{{ player.in_game_name }}</strong>
                                    {% if player.discord_name %}
                                        <br><small class="text-muted">{{ player.discord_name }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if player.guild %}
                                        <span class="badge bg-secondary">{{ player.guild.name }}</span>
                                    {% else %}
                                        <span class="text-muted">No Guild</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if player.game_role %}
                                        <span class="badge bg-info">{{ player.game_role|title }}</span>
                                    {% else %}
                                        <span class="text-muted">No Role</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if player.faction != 'none' %}
                                        <span class="badge bg-warning">{{ player.faction|title }}</span>
                                    {% else %}
                                        <span class="text-muted">No Faction</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if player.discord_user_id %}
                                        <span class="badge bg-success">
                                            <i class="fab fa-discord"></i> Linked
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">Not Linked</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if player.gear_items.exists %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-sword"></i> {{ player.gear_items.count }} items
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">Empty</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if player.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-danger">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'player_loadout' player.id %}" class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted text-center">No players found</p>
            {% endif %}
        </div>
    </div>

    <!-- Statistics and Insights -->
    <div class="col-lg-4 mb-4">
        <!-- Role Distribution -->
        <div class="stats-card mb-4">
            <h4><i class="fas fa-users-cog text-warning"></i> Role Distribution</h4>
            <hr>
            {% if role_distribution %}
                {% for role in role_distribution %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>{{ role.game_role|title|default:"No Role" }}</span>
                    <span class="badge bg-primary">{{ role.count }}</span>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted text-center">No role data</p>
            {% endif %}
        </div>

        <!-- Faction Distribution -->
        <div class="stats-card mb-4">
            <h4><i class="fas fa-flag text-info"></i> Faction Distribution</h4>
            <hr>
            {% if faction_distribution %}
                {% for faction in faction_distribution %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>{{ faction.faction|title|default:"No Faction" }}</span>
                    <span class="badge bg-warning">{{ faction.count }}</span>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted text-center">No faction data</p>
            {% endif %}
        </div>

        <!-- Guild Distribution -->
        <div class="stats-card mb-4">
            <h4><i class="fas fa-landmark text-success"></i> Guild Distribution</h4>
            <hr>
            {% if guild_distribution %}
                {% for guild in guild_distribution %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>{{ guild.guild__name }}</span>
                    <span class="badge bg-success">{{ guild.count }}</span>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted text-center">No guild data</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Players -->
    <div class="col-lg-6 mb-4">
        <div class="stats-card">
            <h4><i class="fas fa-clock text-primary"></i> Recent Players (Last 7 Days)</h4>
            <hr>
            {% if recent_players %}
                {% for player in recent_players %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong>{{ player.in_game_name }}</strong>
                        {% if player.guild %}
                            <span class="badge bg-secondary ms-1">{{ player.guild.name }}</span>
                        {% endif %}
                    </div>
                    <small class="text-muted">{{ player.created_at|date:"M d, Y" }}</small>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted text-center">No recent players</p>
            {% endif %}
        </div>
    </div>

    <!-- Incomplete Profiles -->
    <div class="col-lg-6 mb-4">
        <div class="stats-card">
            <h4><i class="fas fa-exclamation-triangle text-warning"></i> Incomplete Profiles</h4>
            <hr>
            {% if incomplete_profiles %}
                {% for player in incomplete_profiles %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong>{{ player.in_game_name }}</strong>
                        <br>
                        <small class="text-muted">
                            Missing: 
                            {% if not player.discord_user_id %}Discord, {% endif %}
                            {% if not player.game_role %}Role, {% endif %}
                            {% if not player.drifter_1 %}Drifter{% endif %}
                        </small>
                    </div>
                    <a href="{% url 'player_loadout' player.id %}" class="btn btn-sm btn-outline-warning" target="_blank">
                        <i class="fas fa-edit"></i> Complete
                    </a>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-success text-center">All profiles are complete! 🎉</p>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}
